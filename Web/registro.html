<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro - DigiCurva</title>
    <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <style>
        /* --- RESET Y ESTILOS GLOBALES --- */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }

        body, html {
            height: 100%;
            width: 100%;
        }

        /* --- BACKGROUND & OVERLAY --- */
        .background-container {
            width: 100%;
            min-height: 100vh;
            background-image: url('assets/fondoHome.jpg'); /* Fondo similar */
            background-size: cover;
            background-position: center;
            position: relative;
            background-attachment: fixed; /* Efecto parallax simple */
        }

        .overlay {
            width: 100%;
            min-height: 100vh;
            background-color: rgba(56, 189, 248, 0.4); /* Azul claro transparente */
            display: flex;
            flex-direction: column;
        }

        /* --- HEADER --- */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 40px 40px 20px 40px;
        }

        .logo-container {
            display: flex;
            align-items: center;
        }

        .logo-icon {
            width: 35px;
            height: 35px;
            background-color: #1e40af;
            border-radius: 8px;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-right: 10px;
        }

        .logo-text {
            font-size: 28px;
            font-weight: 900;
            color: #fff;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
        }

        .nav-links {
            display: flex;
            gap: 20px;
        }

        .nav-text {
            color: #1e3a8a;
            font-weight: 600;
            font-size: 16px;
            text-decoration: none;
            cursor: pointer;
        }

        /* --- SCROLL CONTENT & CARD --- */
        .scroll-content {
            flex-grow: 1;
            display: flex;
            justify-content: center;
            align-items: flex-start; /* Alineado arriba para permitir scroll */
            padding: 20px;
            overflow-y: auto;
        }

        .card {
            background-color: rgba(255, 255, 255, 0.85);
            border-radius: 20px;
            padding: 40px;
            width: 100%;
            max-width: 900px; /* Max width desktop */
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            margin-bottom: 40px;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .card-title {
            font-size: 32px;
            font-weight: 900;
            color: #000;
        }

        .arrow-button {
            cursor: pointer;
            padding: 5px;
            background: none;
            border: none;
            transition: transform 0.2s;
        }
        .arrow-button:hover { transform: scale(1.1); }

        /* --- FORM GRID SYSTEM --- */
        .form-grid {
            display: flex;
            flex-direction: row; /* Desktop por defecto */
            gap: 40px;
            width: 100%;
        }

        .column {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        /* --- INPUTS --- */
        .input-group {
            margin-bottom: 20px;
            width: 100%;
        }

        .label {
            font-size: 14px;
            color: #333;
            margin-bottom: 8px;
            font-weight: 500;
            display: block;
        }

        .input {
            width: 100%;
            background-color: #fff;
            border-radius: 8px;
            border: 1px solid #d1d5db;
            padding: 12px 15px;
            font-size: 16px;
            color: #000;
            outline: none;
        }

        .input:focus { border-color: #3b82f6; }

        .row-inputs {
            display: flex;
            width: 100%;
            gap: 15px;
        }

        /* --- PHOTO SECTION --- */
        .photo-section {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-top: 10px;
        }

        .photo-placeholder {
            width: 100px;
            height: 100px;
            background-color: #fff;
            border: 1px solid #9ca3af;
            border-radius: 8px;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            position: relative;
        }

        .photo-preview {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .photo-actions {
            display: flex;
            gap: 15px;
        }

        .circle-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.4);
            transition: transform 0.1s;
        }
        .circle-btn:active { transform: scale(0.95); }

        .btn-camera { background-color: #3b82f6; color: white; }
        .btn-file { background-color: #9ca3af; color: white; }

        /* Spinner de carga */
        .spinner {
            border: 3px solid rgba(0,0,0,0.1);
            border-radius: 50%;
            border-top: 3px solid #333;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* --- RESPONSIVE --- */
        @media (max-width: 850px) {
            .header { padding: 20px; }
            .logo-text { font-size: 22px; }
            .card { padding: 20px; width: 95%; }
            .card-title { font-size: 24px; }
            
            .form-grid {
                flex-direction: column; /* Cambiar a columna en móvil */
                gap: 0;
            }
            
            /* Ajuste para la fila de calle/numero */
            .row-inputs {
                flex-direction: row; /* Mantener fila incluso en móvil */
            }
        }
    </style>
</head>
<body>

    <div class="background-container">
        <div class="overlay">
            
            <div class="header">
                <div class="logo-container">
                    <div class="logo-icon">
                        <img src="assets/icon.png" alt="" style="width: 20px; opacity: 0.5;"> </div>
                    <span class="logo-text">DigiCurva</span>
                </div>
                <div class="nav-links">
                    <a href="login.html" class="nav-text">Acceder</a>
                    <a href="#" class="nav-text" style="text-decoration: underline;">Registrarse</a>
                </div>
            </div>

            <div class="scroll-content">
                <div class="card">
                    
                    <div class="card-header">
                        <h2 class="card-title">Cuéntenos sobre usted</h2>
                        <button class="arrow-button" onclick="handleSubmit()">
                            <ion-icon name="arrow-forward" style="font-size: 28px; color: #000;"></ion-icon>
                        </button>
                    </div>

                    <form id="registroForm" onsubmit="event.preventDefault(); handleSubmit();">
                        <div class="form-grid">
                            
                            <div class="column">
                                <div class="input-group">
                                    <label class="label">Nombre(s)</label>
                                    <input type="text" id="nombres" class="input">
                                </div>
                                <div class="input-group">
                                    <label class="label">Apellido(s)</label>
                                    <input type="text" id="apellidos" class="input">
                                </div>
                                <div class="input-group">
                                    <label class="label">Correo electrónico</label>
                                    <input type="email" id="email" class="input">
                                </div>
                                <div class="input-group">
                                    <label class="label">Número de teléfono</label>
                                    <input type="tel" id="telefono" class="input">
                                </div>
                            </div>

                            <div class="column">
                                
                                <div class="row-inputs">
                                    <div class="input-group" style="flex: 3;">
                                        <label class="label">Nombre de calle</label>
                                        <input type="text" id="calle" class="input">
                                    </div>
                                    <div class="input-group" style="flex: 1;">
                                        <label class="label"># de casa</label>
                                        <input type="text" id="numeroCasa" class="input">
                                    </div>
                                </div>

                                <div class="input-group">
                                    <label class="label">Localidad</label>
                                    <input type="text" id="localidad" class="input">
                                </div>

                                <div class="input-group">
                                    <label class="label">Contraseña</label>
                                    <input type="password" id="contrasena" class="input" autocomplete="new-password">
                                </div>

                                <label class="label">Foto (opcional)</label>
                                <div class="photo-section">
                                    
                                    <div class="photo-placeholder" id="photoPreviewBox">
                                        <ion-icon name="person-outline" style="font-size: 40px; color: #333;" id="defaultIcon"></ion-icon>
                                        <img src="" id="previewImg" class="photo-preview" style="display: none;">
                                        <div id="uploadSpinner" class="spinner" style="display: none;"></div>
                                    </div>

                                    <div class="photo-actions">
                                        <button type="button" class="circle-btn btn-camera" onclick="triggerFile('camera')">
                                            <ion-icon name="camera-outline" style="font-size: 24px;"></ion-icon>
                                        </button>

                                        <button type="button" class="circle-btn btn-file" onclick="triggerFile('gallery')">
                                            <span class="material-icons" style="font-size: 24px;">note_add</span>
                                        </button>
                                    </div>

                                    <input type="file" id="fileInput" accept="image/*" style="display: none;" onchange="handleFileSelect(this)">
                                </div>

                            </div>
                        </div>
                    </form>

                </div>
            </div>

        </div>
    </div>

    <script>
        // ESTADO GLOBAL
        let photoFile = null;
        let photoUrlUploaded = ""; // URL final después de subir a PHP
        let uploading = false;

        // 1. Manejo de Selección de Imagen
        function triggerFile(type) {
            const input = document.getElementById('fileInput');
            // En web móvil, el navegador suele preguntar si usar cámara o archivo por defecto.
            // Si quisieras forzar cámara usarías capture="environment", pero dejamos genérico para compatibilidad.
            input.click(); 
        }

        function handleFileSelect(input) {
            if (input.files && input.files[0]) {
                const file = input.files[0];
                photoFile = file;

                // Mostrar Preview
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('defaultIcon').style.display = 'none';
                    const img = document.getElementById('previewImg');
                    img.src = e.target.result;
                    img.style.display = 'block';
                }
                reader.readAsDataURL(file);
            }
        }

        // 2. Función subir imagen a PHP (Replicando uploadToPHP)
        async function uploadToPHP(file) {
            setUploading(true);
            const apiUrl = 'https://ljusstudie.site/SubirImagenBucker/subirImage.php';

            const formData = new FormData();
            formData.append('image', file);
            formData.append('name', 'foto_perfil_' + Date.now() + '.jpg');

            try {
                console.log("Subiendo imagen a...", apiUrl);
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    body: formData
                });
                
                const responseData = await response.json();

                if (response.ok) {
                    console.log("Imagen subida:", responseData);
                    return responseData.url; // Retornamos la URL
                } else {
                    alert("Error servidor imagen: " + (responseData.error || 'Desconocido'));
                    return null;
                }
            } catch (error) {
                console.error("Error red imagen:", error);
                alert("Error al subir la imagen");
                return null;
            } finally {
                setUploading(false);
            }
        }

        // Helper UI Spinner
        function setUploading(isUploading) {
            uploading = isUploading;
            const spinner = document.getElementById('uploadSpinner');
            const img = document.getElementById('previewImg');
            
            if (isUploading) {
                spinner.style.display = 'block';
                img.style.opacity = '0.5';
            } else {
                spinner.style.display = 'none';
                img.style.opacity = '1';
            }
        }

        // 3. Manejo de Submit (Replicando handleSubmit)
        async function handleSubmit() {
            // A. Recolectar datos
            const formData = {
                nombres: document.getElementById('nombres').value,
                apellidos: document.getElementById('apellidos').value,
                email: document.getElementById('email').value,
                telefono: document.getElementById('telefono').value,
                calle: document.getElementById('calle').value,
                numeroCasa: document.getElementById('numeroCasa').value,
                localidad: document.getElementById('localidad').value,
                contrasena: document.getElementById('contrasena').value
            };

            // B. Validación
            if (!formData.nombres || !formData.email || !formData.contrasena || !formData.telefono || 
                !formData.calle || !formData.numeroCasa || !formData.localidad) {
                alert("Complete campos obligatorios");
                return;
            }

            // C. Subir foto si existe (Primero subimos foto, luego registramos)
            let finalImageUrl = "";
            if (photoFile) {
                finalImageUrl = await uploadToPHP(photoFile);
                if (!finalImageUrl) return; // Si falla la subida, detenemos el registro
            }

            // D. Registro (Petición GET/Query Params como en tu código original)
            try {
                // Construcción de la URL
                const baseUrl = 'http://xampp.local/DigiCurvaServer/registro.php';//'https://ljusstudie.site/DigiCurvaServer/registro.php';
                // Construcción del objeto de datos
                const datosRegistro = {
                    nombre: formData.nombres + ' ' + formData.apellidos,
                    correo: formData.email,
                    contrasena_hash: formData.contrasena,
                    telefono: formData.telefono,
                    direccion: `${formData.calle}, ${formData.numeroCasa}, ${formData.localidad}`,
                    foto_perfil_url: finalImageUrl || ''
                };

                console.log("Registrando vía POST en:", baseUrl, " con datos:", formData.nombres);

                const respuesta = await fetch(baseUrl, {
                    method: 'POST',
                    // IMPORTANTE: Enviamos los datos como JSON o como FormData
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(datosRegistro)
                });

                const data = await respuesta.json();

                console.log("Respuesta servidor:", data);

                // E. Manejo de respuesta
                if (data && (data.success)) {
                    alert("¡Registro completado!");
                    window.location.href = 'index.php'; // Redirigir al Home
                } else {
                    const errorMsg = data.error || data.resultado || "Error desconocido.";
                    alert("Error de Registro: " + errorMsg);
                }

            } catch (error) {
                console.error("Error en registro:", error);
                alert("Error de conexión con el servidor.");
            }
        }
    </script>
</body>
</html>